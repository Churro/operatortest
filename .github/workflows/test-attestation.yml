name: Test Attestation with ttl.sh

on:
  workflow_dispatch: # Allows you to trigger this manually from the Actions tab

permissions:
  id-token: write
  attestations: write
  artifact-metadata: write
  contents: read

jobs:
  test-build-and-attest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Define Image Name
        id: vars
        # ttl.sh uses the tag to determine the time-to-live (e.g., 1h, 2h, 1d)
        # We use GITHUB_RUN_ID to ensure a unique image name per workflow run
        run: |
          IMAGE_BASE="ttl.sh/dynatrace-operator-test-${GITHUB_RUN_ID}"
          echo "image_base=$IMAGE_BASE" >> $GITHUB_OUTPUT
          echo "image_tagged=${IMAGE_BASE}:1h" >> $GITHUB_OUTPUT

      - name: Build and push to ttl.sh
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.vars.outputs.image_tagged }}

      - name: Attest Image
        uses: ./.github/actions/attest-image
        with:
          subject-name: ${{ steps.vars.outputs.image_base }}
          subject-digest: ${{ steps.push.outputs.digest }}
